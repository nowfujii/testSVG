<!DOCTYPE html>
<html lang="ja" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Leaflet日本地図</title>
  </head>

<!-- leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- ICON plugin -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
  <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">

<!-- easy button-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

<!-- 日本地図GeoJson/　都道府県データpref-->
  <link rel="stylesheet" href="index2.css">
  <script src="index2.js"></script> <!--このローカルファイルは読み込んでくれてる？？あ！htmlファイルと同じ名前の時いけてる！-->
  <!--<script src="https://nowfujii.github.io/testSVG/japan.js"></script>-->
  <!--  <script src="pref.js" ></script> ローカルファイルを読み込んでくれない-->
  <script src="https://nowfujii.github.io/testSVG/pref.js"></script>





  <body>
    <div id="nuri"></div>
    <div id="map"></div>
  </body>
</html>


<script type="text/javascript">

  //大阪府大阪市
  var lat = 34.6878788;
  var lng = 135.5060062;

  //十字マークアイコン設定
  var crossIcon = L.icon({ iconUrl: 'https://maps.gsi.go.jp/image/map/crosshairs.png', iconSize: [64, 64], iconAnchor: [32, 32] });
  var closeIcon = L.icon({ iconUrl: 'https://maps.gsi.go.jp/image/system/close.png', iconSize: [64, 64], iconAnchor: [32, 32] });
  var viewIcon = L.icon({ iconUrl: 'https://maps.gsi.go.jp/image/system/view.png', iconSize: [64, 64], iconAnchor: [32, 32] });

  //ベースレイヤー：地理院地図　白地図タイル
  var gsiwhite = new L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png', {
    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>©国土地理院:白地図</a>",
    id: '地理院地図:白地図'
  });
  //ベースレイヤー：地理院地図 標準地図タイル
  var gsi = new L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>©国土地理院:標準地図</a>",
    id: '地理院地図:標準'
  });
  //ベースレイヤー：地理院地図 淡色地図タイル
  var gsipale = new L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
    attribution: "<a href='http://portal.cyberjapan.jp/help/termsofuse.html' target='_blank'>©国土地理院:淡色地図</a>",
    id: '地理院地図：淡色地図'
  });
  //ベースレイヤー：地理院地図　航空写真タイル
  var gsiphoto = new L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg',{
    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>©国土地理院:航空写真</a>",
    id: '地理院地図:最新写真'
  });

  //ベースレイヤー：オープンストリート タイル
  var osm = new L.tileLayer('https://tile.openstreetmap.jp/{z}/{x}/{y}.png', {
    attribution: "<a href='https://osm.org/copyright' target='_blank'>OpenStreetMap</a> ©contributors:標準",
    id: 'オープンストリートマップ'
  });

  //ベースレイヤー：Google Map
  var g_map = new L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {
    attribution: "<a href='https://developers.google.com/maps/documentation' target='_blank'>©Google:標準地図</a>",
    id: 'GoogleMap:標準'});
  var g_roadmap = new L.tileLayer('https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}', {
    attribution: "<a href='https://developers.google.com/maps/documentation' target='_blank'>©Google:道路地図</a>",
    id: 'GoogleMap:道路'});
  var g_satelite = new L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
    attribution: "<a href='https://developers.google.com/maps/documentation' target='_blank'>©Google:衛星写真</a>",
    id: 'GoogleMap:衛星写真'});
  var g_hybrid = new L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    attribution: "<a href='https://developers.google.com/maps/documentation' target='_blank'>©Google:ハイブリッド地図</a>",
    id: 'GoogleMap:ハイブリッド'});


  //baseMapsオブジェクトのプロパティに複数のタイルを設定
  var baseMaps = {
    "<span style='font-size:40px'>地理院地図:白</span>" : gsiwhite,
    "<span style='font-size:40px'>地理院地図:標準</span>" : gsi,
    "<span style='font-size:40px'>地理院地図:淡色</span>" : gsipale,
    "<span style='font-size:40px'>地理院地図:航空写真</span>" : gsiphoto,
    "<span style='font-size:40px'>OpenStreetMap</span>"  : osm,
    "<span style='font-size:40px'>Google Map:標準</span>"  : g_map,
    "<span style='font-size:40px'>Google Map:道路</span>"  : g_roadmap,
    "<span style='font-size:40px'>Google Map:衛星写真</span>"  : g_satelite,
    "<span style='font-size:40px'>Google Map:ハイブリッド</span>"  : g_hybrid,
  };


  //leaflet初期設定
  var map = L.map('map', { attributionControl: false, zoomControl: false, zoomSnap: 0.1 }).setView([lat, lng], 4);;  //標準ズームをキャンセルし、ズーム間隔を細かくします
  L.control.attribution({ position: 'bottomleft'}).addTo(map);  //著作表示：左下（標準だと右下）
  gsiwhite.addTo(map);  //国土地理院:白地図　ベース地図初期設定

  //スケール表示
  L.control.scale({ maxWidth: 600, position: 'topleft', imperial: false }).addTo(map);

  //ズームボタン
  L.control.zoom({ position: 'bottomright' , zoomInTitle: 'ズームイン', zoomOutTitle: 'ズームアウト'}).addTo(map);

  //日本列島全体表示ボタン
  L.easyButton({
      position: 'bottomright', // topleft, topright, bottomleft, bottomright
      states: [{
                stateName: 'zoom-to-japan',                   // 状態のIDのようなもの
                icon:      'fas fa-globe',                    // 使用するアイコン https://fontawesome.com/icons?d=gallery&p=2&m=free
                title:     '日本全体',                        // マウスオーバー時にツールチップに表示される名前
                onClick: function(btn, map) {
                    map.setView([lat,lng],4);
                    btn.state('zoom-to-japan');    // ボタンクリック後の状態を指定
                }
  /*             },
               {
                stateName: 'zoom-to-jsonClear',                   // 状態のIDのようなもの
                icon:      '<fas fa-ban',                    // 使用するアイコン https://fontawesome.com/icons?d=gallery&p=2&m=free
                title:     'JsonClear',                        // マウスオーバー時にツールチップに表示される名前
                onClick: function(btn, map) {
                    geojson.setStyle(style2);
                    btn.state('zoom-to-jsonClear');    // ボタンクリック後の状態を指定
               }
  */
      }]
  }).addTo( map );

  //レイヤーグループ
  var geoJsonGroup = new L.layerGroup();
  var markerGroup  = new L.layerGroup();
  var gpsGroup     = new L.layerGroup();
  var crossGroup   = new L.layerGroup();

  //オーバーレイヤー：Japan GeoJsonを２つ定義
  var geoJsonOn    = new L.geoJson(japanJson, { style: style,  onEachFeature: onEachFeature  }).addTo(map);  //黒枠カラー塗り
  var geoJsonOff   = new L.geoJson(japanJson, { style: style2, onEachFeature: onEachFeature2 }).addTo(map);  //黒枠透明
  //レイヤーグループセット
  geoJsonGroup.addLayer(geoJsonOn);   //日本地図データ　カラー塗（都道府県クリックポップアップ表示付き）
  geoJsonGroup.addLayer(geoJsonOff);  //日本地図データ　透明塗（都道府県クリックポップアップ表示付き）


  //県庁所在地マーカーレイヤーグループセット
  for (var i=0; i < prefJson.marker.length; i++){
    //マーカークリック時のポップアップ設定
    var popup = L.popup().setContent( "<span style='font-size:40px'>"+"【<ruby>"+"県庁所在地"+"<rt>"+"けんちょうしょざいち"+"</rt>"+"</ruby>"+ "】<br>"+"</span>"+
                                      "<span style='font-size:60px'>"+"<ruby>"+prefJson.marker[i].city+"<rt>"+prefJson.marker[i].cityyomi+"</rt>"+"</ruby>"+ "<br>"+"</span>",
                                      {maxWidth:400});
    var mk = L.marker( [prefJson.marker[i].lat, prefJson.marker[i].lng], { draggable: false }).bindPopup(popup).addTo(map);
    markerGroup.addLayer(mk);
  }

  // 現在地マーカー
  var popup = L.popup().setContent("<span style='font-size:60px'>"+"<ruby>"+"現在地"+"<rt>"+"げんざいち"+"</rt>"+"</ruby>"+ "<br>"+"</span>");
  var gpsMarker = L.marker( [lat, lng], { draggable: false, icon: closeIcon }).bindPopup(popup).addTo(map);
  gpsGroup.addLayer(gpsMarker);       //gpsマーカーグループセット

  // 十字マークを地図中央に表示
  var crossMarker = L.marker( map.getCenter(),{ icon:crossIcon, zIndexOffset:1000, interactive:false }).addTo(map);
  crossGroup.addLayer(crossMarker);

  // コントローラーの選択追加
  var overlayLayerControls = {
    "<span style='font-size:40px'>地方名別色</span>": geoJsonOn,
    "<span style='font-size:40px'>選択時不透明</span>": geoJsonOff,
    "<span style='font-size:40px'>現在地マーカー</span>": gpsGroup,
    "<span style='font-size:40px'>県庁所在地マーカー</span>": markerGroup,
    "<span style='font-size:40px'>十字マーク</span>": crossGroup,
  };

  //グループ初期設定
  geoJsonOn.addTo(map);     //地方名別色
  geoJsonOff.addTo(map);    //選択時不透明
  markerGroup.addTo(map);   //県庁所在地マーカー
  gpsGroup.addTo(map);      //GPSマーカー
  crossGroup.addTo(map);    //十字マーク

  //地図選択ボタン
  L.control.layers(baseMaps, overlayLayerControls, { collapsed: true, }).addTo(map);


  // 十字マークのGPS位置を表示する
  map.on('moveend', function(e) {
    crossMarker.setLatLng(map.getCenter());
    var mes = "lat: " + map.getCenter().lat + " lng: " + map.getCenter().lng;
    console.log(mes);

    if (window.Unity){
      Unity.call(mes);   //Unityへ送信：ブラウザのエラーは無視
    }
  });





  //読み込みエラー
  if (!window.prefJson){
    console.log("prefJsonが読み込めていない！！！");  //デバッグ表示
    //Unity.call("prefJsonが読み込めていない！！！");   //Unityへ送信：ブラウザのエラーは無視
  }
  if (!window.japanJson){
    console.log("japanJsonが読み込めていない！！！");  //デバッグ表示
    //Unity.call("japanJsonが読み込めていない！！！");   //Unityへ送信：ブラウザのエラーは無視
  }






//インタラクション
  // 現在地を取得
  function getgeo() {
    map.on('locationerror', onLocationError);
    map.locate({
      setView: "true"
    });
  }
  function onLocationError(e) {
    alert(e.message);
  }

  //通常表示 // 黒枠カラー塗りスタイル
  function style(feature) {
    return {        color: '#000', fillColor: getColor(feature.properties.area), weight: 2, opacity: 1, fillOpacity: 1 };    //薄緑
  }
  // get color depending on population area value
  function getColor(d) {
      return  d == "北海道地方" ? '#796BAF' :
              d == "東北地方"   ? '#6C9BD2' :
              d == "関東地方"   ? '#54C3F1' :
              d == "中部地方"   ? '#61C1BE' :
              d == "近畿地方"   ? '#69BD83' :
              d == "四国地方"   ? '#C1DB81' :
              d == "中国地方"   ? '#FFF67F' :
              d == "九州地方"   ? '#F9C270' :
                                  '#EF845C' ;
                                 //#EF858C
                                 //#EE87B4
                                 //#BA79B1
  }

  //透明表示 // 黒枠透明スタイル
  function style2(feature) {
    return {        color: '#000', fillColor: '#fff', weight: 2, opacity: 1, fillOpacity: 0.1 }; //白透明
  }

  //マウスホバー時　ハイライト表示 // 黒枠薄赤塗り半透明スタイル
  function highlightFeature(e) {
    var layer = e.target;
    layer.setStyle({ color: '#000', fillColor: '#f00', weight: 2, opacity: 1, fillOpacity: 0.1}); //薄赤
  }
  function highlightFeature2(e) {
    var layer = e.target;
    layer.setStyle({ color: '#000', fillColor: '#f00', weight: 2, opacity: 1, fillOpacity: 0.05 });  //薄赤
  }
  //マウスホバー時　ハイライト表示　リセット
  function resetHighlight(e) {
    geoJsonOn.resetStyle(e.target);
  }
  function resetHighlight2(e) {
    geoJsonOff.resetStyle(e.target);
  }

  //クリック時のイベントとして呼ばれる　ズーム
  function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());              //都道府県のサイズと位置にフィットしズームも自動調整される

    console.log(e.target.feature.properties.nam_ja);  //デバッグ表示

    if (window.Unity){
      Unity.call(e.target.feature.properties.nam_ja);   //Unityへ送信：ブラウザのエラーは無視
    }
  }

  //ON:クリック時の動作
  function onEachFeature(feature, layer) {
    setInfo(feature, layer);

    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: zoomToFeature
    });
  }
  //OFF:クリック時の動作
  function onEachFeature2(feature, layer) {
    setInfo(feature, layer);

    layer.on({
        mouseover: highlightFeature2,
        mouseout: resetHighlight2,
        click: zoomToFeature
    });
  }

  //都道府県データのセット
  function setInfo(feature, layer) {
    var i = feature.properties.id-1;
    if (i >= 0 && i < 47){
      var id         = prefJson.marker[i].id;
      var pref       = prefJson.marker[i].pref;
      var city       = prefJson.marker[i].city;
      var localGroup = prefJson.marker[i].localGroup;
      var prefyomi   = prefJson.marker[i].prefyomi;
      var cityyomi   = prefJson.marker[i].cityyomi;
      var LGyomi     = prefJson.marker[i].LGyomi;
      var url        = prefJson.marker[i].url;
      var addr       = prefJson.marker[i].addr;
      var lat        = prefJson.marker[i].lat;
      var lng        = prefJson.marker[i].lng;
//      console.log("<span style='font-size:50px'>"+id +":"+pref+"</span>");

      //地方名＋都道府県名　セット
      layer.bindPopup ( "<span style='font-size:50px'>"+
                        "【<ruby>" + localGroup + "<rt>" + LGyomi + "</rt>" + "</ruby>" + "】<br>" +     //地方名＋ルビ
                        id + ":" + "<ruby>" + pref + "<rt>" + prefyomi + "</rt>" + "</ruby>" + "<br>" +  //都道府県＋ルビ
                        "</span>"
                      );
    }
  }


  //Unityからロードされたjsデータが送られてくる
//  window.addEventListener('DOMContentLoaded', function(){
//    /** jQueryの処理 */
//  });

//  Unity.LoadJs = function(data){
//      console.log(data);
//  }


</script>